<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperTizen Control Center</title>
    <link rel="stylesheet" href="main.css">
    <script src="js/wsClient.js"></script>
    <script type="text/javascript" src="$WEBAPIS/webapis/webapis.js"></script>
</head>

<body>
    <!-- Rainbow border animation (active when capturing) -->
    <div id="rainbowBorder" class="rainbow-border"></div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üöÄ HyperTizen Control Center</h1>
            <div class="status-indicator" id="captureStatus">
                <div class="indicator-dot"></div>
                <span id="captureStatusText">Ready</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">

            <!-- Left Column: Service Control & SSDP Devices -->
            <div class="left-column">

                <!-- Service Control Section -->
                <div class="section service-control">
                    <h2>Service Control</h2>
                    <div class="control-buttons">
                        <button class="btn btn-start" id="btnStart" tabindex="1">
                            ‚ñ∂ Start Capture
                        </button>
                        <button class="btn btn-stop" id="btnStop" tabindex="2">
                            ‚èπ Stop Capture
                        </button>
                        <button class="btn btn-restart" id="btnRestart" tabindex="3">
                            üîÑ Restart Service
                        </button>
                    </div>
                    <div class="service-status">
                        <div class="status-row">
                            <span class="label">Service:</span>
                            <span id="serviceStatus" class="value">Unknown</span>
                        </div>
                        <div class="status-row">
                            <span class="label">Capture:</span>
                            <span id="captureState" class="value">Stopped</span>
                        </div>
                        <div class="status-row">
                            <span class="label">Connection:</span>
                            <span id="connectionStatus" class="value">Disconnected</span>
                        </div>
                    </div>
                </div>

                <!-- SSDP Devices Section -->
                <div class="section ssdp-devices">
                    <h2>SSDP Devices</h2>
                    <div class="ssdp-info">
                        <span id="ssdpCount">0</span> device(s) found
                    </div>
                    <div class="device-list" id="deviceList">
                        <div class="no-devices">
                            Scanning for Hyperion/HyperHDR devices...
                        </div>
                    </div>
                    <div class="ssdp-actions">
                        <button class="btn btn-small" id="btnRescan" tabindex="4">
                            üîç Rescan
                        </button>
                        <button class="btn btn-small btn-primary" id="btnApplyDevices" tabindex="5">
                            ‚úì Apply Selection
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Logs -->
            <div class="right-column">
                <div class="section logs-section">
                    <div class="logs-header">
                        <h2>Live Logs</h2>
                        <div class="logs-controls">
                            <label class="checkbox-label">
                                <input type="checkbox" id="autoScroll" checked>
                                <span>Auto-scroll</span>
                            </label>
                            <button class="btn btn-small" id="btnClearLogs" tabindex="6">
                                üóë Clear
                            </button>
                        </div>
                    </div>
                    <div class="logs-container" id="logsContainer">
                        <div class="log-entry info">
                            <span class="timestamp">[--:--:--]</span>
                            <span class="type">[Info]</span>
                            <span class="message">Connecting to HyperTizen service...</span>
                        </div>
                    </div>
                    <div class="logs-footer">
                        <span id="logCount">1</span> log entries
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-info">
                <span>HyperTizen v1.0 | Tizen 8.0+ Fork</span>
                <span class="separator">‚Ä¢</span>
                <span id="wsStatus">WebSocket: Disconnected</span>
            </div>
            <div class="footer-help">
                Use <kbd>‚Üë</kbd> <kbd>‚Üì</kbd> to navigate, <kbd>Enter</kbd> to select
            </div>
        </div>
    </div>

    <script>
        // Initialize the application
        window.onload = function () {
            // Focus management for remote control
            setupFocusManagement();

            // Get device IP and initialize WebSocket connections
            fetch('http://127.0.0.1:8081')
                .then(res => res.text())
                .then(ip => {
                    window.deviceIP = ip;
                    initializeApp(ip);
                })
                .catch(err => {
                    console.error('Failed to get device IP:', err);
                    addLog('Error', 'Failed to get device IP. Retrying...');
                    setTimeout(() => location.reload(), 3000);
                });
        };

        function setupFocusManagement() {
            let focusableElements = [];
            let currentFocusIndex = -1;

            function updateFocusableElements() {
                // Get all focusable elements in document order
                focusableElements = Array.from(
                    document.querySelectorAll('button:not([disabled]), input[type="checkbox"], .device-item')
                );

                // If current element is no longer focusable, reset index
                if (currentFocusIndex >= focusableElements.length) {
                    currentFocusIndex = focusableElements.length - 1;
                }
            }

            function focusElement(index) {
                if (index >= 0 && index < focusableElements.length) {
                    focusableElements[index].focus();
                    currentFocusIndex = index;

                    // Scroll element into view if needed
                    focusableElements[index].scrollIntoView({
                        behavior: 'smooth',
                        block: 'nearest',
                        inline: 'nearest'
                    });
                }
            }

            // Handle keyboard navigation for TV remote
            document.addEventListener('keydown', function (e) {
                updateFocusableElements();

                // Initialize focus if not set
                if (currentFocusIndex === -1 && focusableElements.length > 0) {
                    currentFocusIndex = 0;
                    focusElement(0);
                    return;
                }

                const key = e.keyCode || e.which;

                switch (e.key || key) {
                    case 'ArrowDown':
                    case 40: // Down arrow keyCode
                        e.preventDefault();
                        e.stopPropagation();
                        if (currentFocusIndex < focusableElements.length - 1) {
                            focusElement(currentFocusIndex + 1);
                        } else {
                            // Wrap to first element
                            focusElement(0);
                        }
                        break;

                    case 'ArrowUp':
                    case 38: // Up arrow keyCode
                        e.preventDefault();
                        e.stopPropagation();
                        if (currentFocusIndex > 0) {
                            focusElement(currentFocusIndex - 1);
                        } else {
                            // Wrap to last element
                            focusElement(focusableElements.length - 1);
                        }
                        break;

                    case 'ArrowLeft':
                    case 37: // Left arrow keyCode
                        e.preventDefault();
                        e.stopPropagation();
                        // For horizontal navigation within the same row (optional)
                        break;

                    case 'ArrowRight':
                    case 39: // Right arrow keyCode
                        e.preventDefault();
                        e.stopPropagation();
                        // For horizontal navigation within the same row (optional)
                        break;

                    case 'Enter':
                    case 13: // Enter keyCode
                        e.preventDefault();
                        e.stopPropagation();
                        if (currentFocusIndex >= 0 && currentFocusIndex < focusableElements.length) {
                            const element = focusableElements[currentFocusIndex];

                            // Special handling for checkboxes
                            if (element.type === 'checkbox') {
                                element.checked = !element.checked;
                                // Trigger change event
                                const event = new Event('change', { bubbles: true });
                                element.dispatchEvent(event);
                            } else {
                                // For buttons and other elements, trigger click
                                element.click();
                            }
                        }
                        break;

                    case 'Back':
                    case 10009: // Samsung TV Back button
                        // Allow default back behavior
                        break;
                }
            });

            // Track focus changes
            document.addEventListener('focus', function (e) {
                updateFocusableElements();
                const index = focusableElements.indexOf(e.target);
                if (index !== -1) {
                    currentFocusIndex = index;
                }
            }, true);

            // Track active element changes
            document.addEventListener('blur', function (e) {
                // Update focusable elements when something loses focus
                updateFocusableElements();
            }, true);

            // Initialize focus on first button
            setTimeout(() => {
                updateFocusableElements();
                if (focusableElements.length > 0) {
                    focusElement(0);
                }
            }, 100);

            // Observe DOM changes to update focusable elements
            const observer = new MutationObserver(() => {
                const previousLength = focusableElements.length;
                updateFocusableElements();

                // If new elements were added and we had no focus, focus the first one
                if (previousLength === 0 && focusableElements.length > 0 && currentFocusIndex === -1) {
                    focusElement(0);
                }
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true,
                attributes: true,
                attributeFilter: ['disabled']
            });

            // Store in window for debugging
            window.focusDebug = {
                getFocusableElements: () => focusableElements,
                getCurrentIndex: () => currentFocusIndex,
                focusElement: focusElement
            };
        }
    </script>
</body>

</html>
